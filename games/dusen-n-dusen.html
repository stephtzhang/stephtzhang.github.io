<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@7.2.5/konva.min.js"></script>
    <meta charset="utf-8" />
    <title>dusen n' dusen drawing</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f8f8ff;
        display: flex;
      }
      .canvas {
        width: 50%;
      }
      #left {
        background-color: #f8f8ff;
      }
      #right {
        background-color: #141414;
      }

    </style>
  </head>
  <body>
    <div class="canvas" id="left"></div>
    <div class="canvas" id="right"></div>
    <script>
      const ORANGE = "#fca503";
      const BLUE = "#4287f5";
      const GREEN = "#32a852";
      const MAGENTA = "#ad3499";
      const COLORS = [ORANGE, BLUE, GREEN, MAGENTA];

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        //The maximum is exclusive and the minimum is inclusive
        return Math.floor(Math.random() * (max - min) + min);
      }

      function getRandomElement(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      function makeRandomBox(x, y) {
        return new Konva.Rect({
          x: x,
          y: y,
          width: getRandomInt(100, 300),
          height: getRandomInt(100, 300),
          fill: getRandomElement(COLORS),
          draggable: true,
        });
      }

      function makeRandomPolygon(x, y) {
        return new Konva.RegularPolygon({
          x: x,
          y: y,
          sides: 6,
          radius: getRandomInt(100, 200),
          fill: getRandomElement(COLORS),
          draggable: true,
        });
      }

      function makeRandomCircle(x, y) {
        return new Konva.Circle({
          x: x,
          y: y,
          radius: getRandomInt(100, 200),
          fill: getRandomElement(COLORS),
          draggable: true,
        });
      }

      function makeShape(x, y ) {
        var shapeFuncs = [makeRandomPolygon, makeRandomBox, makeRandomCircle];
        var shapeFunc = getRandomElement(shapeFuncs);
        var shape = shapeFunc(x, y)

        // add cursor styling
        shape.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
        });
        shape.on('mouseout', function () {
          document.body.style.cursor = 'default';
        });

        return shape;
      }

      // // // // // //
      // LEFT HERE. //
      // // // // // //

      var CONTAINER_WIDTH = window.innerWidth / 2;
      var CONTAINER_HEIGHT = window.innerHeight;

      var leftStage = new Konva.Stage({
        container: 'left',
        width: CONTAINER_WIDTH,
        height: CONTAINER_HEIGHT,
      });

      var leftLayer = new Konva.Layer();

      function dropLeftShape(event) {
        var shape = makeShape(event.clientX, event.clientY);
        leftLayer.add(shape);
        leftStage.add(leftLayer);
      }

      document.getElementById('left').addEventListener(
        'dblclick',
        dropLeftShape,
      );

      // // // // // //
      // RIGHT HERE. //
      // // // // // //
      var rightStage = new Konva.Stage({
        container: 'right',
        width: CONTAINER_WIDTH,
        height: CONTAINER_HEIGHT,
      });

      var rightLayer = new Konva.Layer();


      function dropRightShape(event) {
        var shape = makeShape(event.clientX - CONTAINER_WIDTH, event.clientY);
        rightLayer.add(shape);
        rightStage.add(rightLayer);
      }

      document.getElementById('right').addEventListener(
        'dblclick',
        dropRightShape,
      );

      // // // // // // //
      // DOWNLOAD HERE. //
      // // // // // // //

      // function from https://stackoverflow.com/a/15832662/512042
      function downloadURI(uri, name) {
        var link = document.createElement('a');
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        delete link;
      }

      // https://stackoverflow.com/questions/3318565/any-way-to-clone-html5-canvas-element-with-its-content
      function cloneCanvas(oldCanvas) {
        //create a new canvas
        var newCanvas = document.createElement('canvas');
        var context = newCanvas.getContext('2d');

        //set dimensions
        newCanvas.width = oldCanvas.width;
        newCanvas.height = oldCanvas.height;

        //apply the old canvas to the new one
        context.drawImage(oldCanvas, 0, 0);

        //return the new canvas
        return newCanvas;
      }

      // https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas
      function spliceAndSave() {
        var canvasList = document.getElementsByTagName("canvas");
        var leftCanvas = canvasList[0];
        var leftCtx = leftCanvas.getContext("2d");
        var rightCanvas = canvasList[1];
        var rightCtx = rightCanvas.getContext("2d");
        var ctxList = [leftCtx, rightCtx];
        var tempCanvas = cloneCanvas(leftCanvas);
        var tempCtx = tempCanvas.getContext("2d")

        const step = 25;
        for (let pixel = 0; pixel < tempCanvas.width; pixel += step) {
          var i = (pixel / step) % 2;
          var imageData = ctxList[i].getImageData(pixel, 0, step, tempCanvas.height);
          tempCtx.putImageData(imageData, pixel, 0);
        }

        var dataURL = tempCanvas.toDataURL("image/png");
        downloadURI(dataURL, 'dusen-n-dusen.png');
      }

      function handleKeyDown(event) {
        if (event.code === "Space") {
          spliceAndSave();
        }
      }
      document.addEventListener('keydown', handleKeyDown);

    </script>
  </body>
</html>