<!DOCTYPE html>
<html>
  <head>
    <script src="https://unpkg.com/konva@7.2.5/konva.min.js"></script>
    <meta name="viewport" content="width=device-width" />
    <meta charset="utf-8" />
    <title>dusen n' dusen drawing</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      .container {
        width: 100%;
        display: flex;
        flex-direction: column;
      }
      .canvas {
        width: 100%;
        height: 50vh;
      }
      @media only screen and (min-width: 768px) {
        .container {
          display: flex;
          flex-direction: row;
        }
        .canvas {
          width: 50%;
          height: 100vh;
        }

      }
      #light {
        background-color: #f8f8ff;
      }
      #dark {
        background-color: #141414;
      }

    </style>
  </head>
  <body>
    <div class="container">
        <div class="canvas" id="light"></div>
        <div class="canvas" id="dark"></div>
    </div>
    <script>
      const ORANGE = "#fca503";
      const BLUE = "#4287f5";
      const GREEN = "#32a852";
      const MAGENTA = "#ad3499";
      const COLORS = [ORANGE, BLUE, GREEN, MAGENTA];

      function getRandomInt(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        //The maximum is exclusive and the minimum is inclusive
        return Math.floor(Math.random() * (max - min) + min);
      }

      function getRandomElement(array) {
        return array[Math.floor(Math.random() * array.length)];
      }

      function makeRandomBox(x, y) {
        return new Konva.Rect({
          x: x,
          y: y,
          width: getRandomInt(100, 300),
          height: getRandomInt(100, 300),
          fill: getRandomElement(COLORS),
          draggable: true,
        });
      }

      function makeRandomPolygon(x, y) {
        return new Konva.RegularPolygon({
          x: x,
          y: y,
          sides: 6,
          radius: getRandomInt(100, 200),
          fill: getRandomElement(COLORS),
          draggable: true,
        });
      }

      function makeRandomCircle(x, y) {
        return new Konva.Circle({
          x: x,
          y: y,
          radius: getRandomInt(100, 200),
          fill: getRandomElement(COLORS),
          draggable: true,
        });
      }

      function makeShape(x, y ) {
        var shapeFuncs = [makeRandomPolygon, makeRandomBox, makeRandomCircle];
        var shapeFunc = getRandomElement(shapeFuncs);
        var shape = shapeFunc(x, y)

        // add cursor styling
        shape.on('mouseover', function () {
          document.body.style.cursor = 'pointer';
        });
        shape.on('mouseout', function () {
          document.body.style.cursor = 'default';
        });

        return shape;
      }

      // // // // // //
      // LEFT HERE. //
      // // // // // //

      class ShapeStage {
        constructor(container, width, height) {
          this.stage = new Konva.Stage({
            container: container,
            width: width,
            height: height,
          });
          var layer = new Konva.Layer();
          this.stage.add(layer);
          this.stage.on('dblclick dbltap', this.dropShape);
        }

        dropShape(event) {
          const pointerPosition = this.getStage().getPointerPosition();
          const x = pointerPosition.x;
          const y = pointerPosition.y;
          var shape = makeShape(x, y);
          var layer = this.getStage().getLayers()[0]
          layer.add(shape);
          this.getStage().add(layer);
        }
      }

      const STAGE_WIDTH = document.getElementById('dark').offsetWidth;
      const STAGE_HEIGHT = document.getElementById('dark').offsetHeight;

      var lightStage = new ShapeStage('light', STAGE_WIDTH, STAGE_HEIGHT);
      var darkStage = new ShapeStage('dark', STAGE_WIDTH, STAGE_HEIGHT);

      // // // // // // //
      // DOWNLOAD HERE. //
      // // // // // // //

      // function from https://stackoverflow.com/a/15832662/512042
      function downloadURI(uri, name) {
        var link = document.createElement('a');
        link.download = name;
        link.href = uri;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        delete link;
      }

      // https://stackoverflow.com/questions/3318565/any-way-to-clone-html5-canvas-element-with-its-content
      function cloneCanvas(oldCanvas) {
        //create a new canvas
        var newCanvas = document.createElement('canvas');
        var context = newCanvas.getContext('2d');

        //set dimensions
        newCanvas.width = oldCanvas.width;
        newCanvas.height = oldCanvas.height;

        //apply the old canvas to the new one
        context.drawImage(oldCanvas, 0, 0);

        //return the new canvas
        return newCanvas;
      }

      // https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API/Tutorial/Pixel_manipulation_with_canvas
      function spliceAndSave() {
        var canvasList = document.getElementsByTagName("canvas");
        var leftCanvas = canvasList[0];
        var leftCtx = leftCanvas.getContext("2d");
        var rightCanvas = canvasList[1];
        var rightCtx = rightCanvas.getContext("2d");
        var ctxList = [leftCtx, rightCtx];
        var tempCanvas = cloneCanvas(leftCanvas);
        var tempCtx = tempCanvas.getContext("2d")

        const step = 25;
        for (let pixel = 0; pixel < tempCanvas.width; pixel += step) {
          var i = (pixel / step) % 2;
          var imageData = ctxList[i].getImageData(pixel, 0, step, tempCanvas.height);
          tempCtx.putImageData(imageData, pixel, 0);
        }

        var dataURL = tempCanvas.toDataURL("image/png");
        downloadURI(dataURL, 'dusen-n-dusen.png');
      }

      function handleKeyDown(event) {
        if (event.code === "Space") {
          spliceAndSave();
        }
      }
      document.addEventListener('keydown', handleKeyDown);

    </script>
  </body>
</html>